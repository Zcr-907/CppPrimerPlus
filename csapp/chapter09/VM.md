###  VM: virtual memory

`虚拟内存是硬件异常、硬件地址翻译、主存、磁盘文件和内核软件的完美交互，它为每个进程提供了一个大的、一致的和私有的地址空间`

#### 基本概念

* 物理内存: DRAM存储器
* 虚拟内存: 虚拟内存被组织为一个由存放在磁盘上的N个连续的字节大小的单元组成的数组
* 虚拟寻址: CPU生成一个虚拟地址来访问主存,主存中的"内存管理单元(MMU)"通过页表动态将虚拟地址翻译成内存中的物理地址
* 物理内存地址(PA)与虚拟内存地址(VP)数据表示:
  * 相同位数的低X位表示地址便宜,二者相同(VPO=PPO)
  * 二者的其余高位,位数与值并不相同(VPN != PPN)
* 页表条目(PTE): 
  * 虚拟内存与PTE是一一对应的关系(不同的进程占有各自的虚拟内存空间,且数据结构相同,各自的页表也是独占的)
  * 有效位=1,数据位存储的未PPN
  * 有效位=0,数据位无地址,表示未分配
  * 有效位=0,数据位有地址,表示未缓存,磁盘已映射到虚拟内存,只不过未被加载进屋里内存
* 存储在内存管理单元(MMU)的块表(TLB): 缓存一些已知的PTE信息

#### CPU通过PTE寻址过程

* CPU读取VP3 (VP3=VPN3+VPO3)
* OS根据VPN3获取PTE对应的数据
  * PTE有效位=1,拼接PPN3+VPO3=PPO3=PA,进入下一步
  * PTE有效位=0,缺页异常,(加载VP3进对应的物理页),(缺页,计算出牺牲页,如果dirty就写回磁盘,然后将虚拟页写入物理页),并更新PTE
* 将得到的PA根据内存块的组相连信息(组ID,块ID)获取内存中的数据

#### CPU通过TLB寻址理解

* CPU根据虚拟地址(VA)尝试在内存管理单元(MMU)中去匹配块表(TLB): 根据VPN不同的区间获取TLB(组和块)中的PPN

  * 将虚拟页号(VPN)分割成TLB的标记索引(TLBT)和组索引(TLBI)
  * 根据TLB中查找到的信息[物理页号(PPN),有效标记位]判断是否有效
  * 如果有效的话将PPN与VA切割出的虚拟地址偏移(VPO)拼接成物理地址
  * 将得到的物理地址分割成组索引(CI),块索引(CO),组标记(CT),通过有效标记位和上诉信息在RAM中的缓存块中匹配正确的数据返回给CPU

  

  #### 简述一个运行在Linux上的Intel core i7的寻址过程

  ```
  四个独立的核,拥有一个层次结构的高速缓存结构(L1,L2),一个层次结构的块表(TLB),与前者一一对应
  ```

  * 1.CPU发送虚拟地址给L1-TLB,根据计算规则尝试从TLB中获取到对应的物理页号(PPN),基于虚拟地址偏移(VPO)与物理地址偏移(PPO)都是相同的(低12位),所以可以拼接出一个完整的物理地址
  * 2.根据得到的物理地址在L1高速缓存中,找到对应的数据块
  * 3.如果step1不成功,就直接将VPN分成4片(VPN1,VPN2,VPN3,VPN4)分别对应四级页表结构找到最终的PPN,回到step2
    * 这是基于VPN与PTE(页表条目)一一对应的关系
  * 4.如果step2不成功,将上述步骤得到的物理地址请求下级缓存,
     *   下级缓存如果缓存命中就返回数据,缓存不命中直至发生缺页中断异常,将数据换入物理内存,负责重复step4

  

  

  

